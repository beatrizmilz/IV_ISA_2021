---
title: "Create a dataset with downloaded files"
author: "Beatriz Milz"
date: "08/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(magrittr)
```

```{r}
dataset_download <- readr::read_rds("data/dataset_df_minutes_download_2020-12-08.Rds")
```


```{r}
extensions <- dataset_download %>% 
    dplyr::filter(!formato_link %in% c(".jpg", ".htm", ".doc")) %>% 
  dplyr::distinct(formato_link) %>%
  dplyr::pull(formato_link) %>% 
  stringr::str_remove_all("\\.")


read_different_file_extensions <- function(ext){


# htm nao ta funcionando muito bem, mas o html está!
  
  reading_files <- list.files(
  path = "data/minutes_files",
  recursive =
    TRUE,
  full.names = TRUE,
  pattern = glue::glue(".{ext}$")
) %>%
  readtext::readtext()

readr::write_rds(reading_files, file = glue::glue( "data/reading_downloaded_files/reading_{ext}_{Sys.Date()}.rds"))

reading_files

}

#read_different_file_extensions(".doc")
```


```{r}
read_htm_file_extensions <- function(){
  
 htm_files <- list.files(
  path = "data/minutes_files",
  recursive =
    TRUE,
  full.names = TRUE,
  pattern = glue::glue(".htm$")
)
 
 dataset_html <-  tibble::tibble(doc_id = as.character(), text = as.character())
 
 for (i in 1:length(htm_files)) {
   doc_id_i <- htm_files[i] %>% fs::path_file()
   
   text_i <- htm_files[i] %>%
     purrr::map(xml2::read_html) %>%
     purrr::map(~ rvest::html_nodes(.x, 'p,h1,h2,h3')) %>%
     purrr::map(~ rvest::html_text(.x) %>%
                  stringr::str_squish()) %>%
     unlist() %>%
     paste0(collapse = " ")
   
    dataset_html <- dataset_html %>% tibble::add_row(doc_id = doc_id_i, text = text_i)
   
  
 }
 
readr::write_rds(dataset_html, file = glue::glue( "data/reading_downloaded_files/reading_htm_{Sys.Date()}.rds"))

dataset_html
 
}

```


```{r}
read_doc_file_extensions <- function() {
  doc_files <- list.files(
    path = "data/minutes_files",
    recursive =
      TRUE,
    full.names = TRUE,
    pattern = glue::glue(".doc$")
  )
  
  dataset_doc <-
    tibble::tibble(doc_id = as.character(), text = as.character())
  
  for (i in 1:length(doc_files)) {
 
    doc_id_i <- doc_files[i] %>% fs::path_file()
    
    
    text_anti <-
      purrr::possibly(antiword::antiword, otherwise = "Erro Antiword")
    
    text_i <- text_anti(doc_files[i]) %>% 
      stringr::str_squish() %>%
      unlist() %>%
      paste0(collapse = " ")
    
  
    dataset_doc <-
      dataset_doc %>% tibble::add_row(doc_id = doc_id_i, text = text_i)
    
    paste0(glue::glue("Index baixado: {i}"))
    
  }
  
  readr::write_rds(
    dataset_doc,
    file = glue::glue(
      "data/reading_downloaded_files/reading_doc_{Sys.Date()}.rds"
    )
  )
  
  dataset_doc
  
}


```




```{r}
# Abrir vários tipos, exceto JPG, htm, doc
purrr::map(.x = extensions, .f = purrr::possibly(read_different_file_extensions, otherwise = "ERRO"))

# Abrir htm

read_htm_file_extensions() 
read_doc_file_extensions() 

```

```{r}
# Quais são os arquivos que deram erro com o antiword?
arquivos_erro_antiword <-
  united_clean_text %>% dplyr::filter(text == "Erro Antiword") %>% dplyr::select(nome_arquivo_salvar) %>%
  dplyr::mutate(
    nome_arquivo = fs::path_file(nome_arquivo_salvar),
    novo_arquivo = glue::glue("data/minutes_files/erro_antiword/{nome_arquivo}")
  )

fs::file_copy(
  path = arquivos_erro_antiword$nome_arquivo_salvar,
  new_path = arquivos_erro_antiword$novo_arquivo,
  overwrite = TRUE
)


## Converti em PDF esses arquivos MANUALMENTE
list.files(
  path = "data/minutes_files/erro_antiword/PDF/",
  recursive =
    TRUE,
  full.names = TRUE,
  pattern = glue::glue(".pdf$")
) %>%
  readtext::readtext() %>%
  readr::write_rds(
    file = glue::glue(
      "data/reading_downloaded_files/reading_pdf_erro_antiword_{Sys.Date()}.rds"
    )
  )


```


```{r}
loaded_files <- list.files("data/reading_downloaded_files/", full.names = TRUE) %>% 
  purrr::map_dfr(readr::read_rds) 





united_loaded_files <- loaded_files %>%
 dplyr::filter(text != "Erro Antiword",
               doc_id != "at-1994-11-18-ata_1-ata-de-fundacao-e-instalacao-do-cbh-at-doe-18-11-94-caderno-executivo-i-pagina-56.pdf")   %>%
  dplyr::full_join(dataset_download, by = c("doc_id" = "nome_arquivo_curto"))







united_clean_text <- united_loaded_files %>%
  dplyr::mutate(
    texto = stringr::str_replace_all(text, "_", " "),
    texto = stringr::str_squish(texto)
    )

# head(united_clean_text$texto)


```
```{r}
#verificando repetidos, quase 100, para nao duplicar reuniao no corpus





# Remover câmara técnica
dataset_download %>% 
  dplyr::filter(!stringr::str_detect(nome_reuniao, "Câmara Técnica|Grupo Técnico|CTPLAGRHI")) %>% 
  dplyr::filter(numero_link != "ata_1", 
                formato_link != ".jpg", 
                n_ugrhi == 9
                ) %>%
  dplyr::arrange(comite, data_reuniao) %>% 
  dplyr::filter(
    !nome_arquivo_salvar %in% c(
      # Anexos só com nomes, não tem texto
      "data/minutes_files/at/at-2013-08-30-ata_1-anexo-a-ata-de-30-08-2013-convidados",
      "data/minutes_files/at/at-2013-08-30-ata_2-anexo-a-ata-de-30-08-2013-estado.pdf",
      "data/minutes_files/at/at-2013-08-30-ata_3-anexo-a-ata-de-30-08-2013-municipio.pdf",
      "data/minutes_files/at/at-2013-08-30-ata_4-anexo-a-ata-de-30-08-2013-sociedade-civil.pdf",
      # Alguns oferecem a ata completa e o resumo executivo, dei preferência para ata completa
      "data/minutes_files/at/at-2011-03-31-ata_2-resumo-executivo-da-ata-31-03-2011-aprovada.pdf",
      "data/minutes_files/at/at-2011-02-16-ata_2-resumo-executivo-da-ata-16-02-atualizada-pos-reuniao.pdf",
      "data/minutes_files/at/at-2011-03-31-ata_2-resumo-executivo-da-ata-31-03-2011-aprovada.doc",
      "data/minutes_files/at/at-2011-02-16-ata_2-resumo-executivo-da-ata-16-02-atualizada-pos-reuniao.doc",
      "data/minutes_files/at/at-2007-04-12-ata_2-ata-reuniao-extraordinaria-do-cbh-at_12_04_2007.doc",
      
      "data/minutes_files/bs/bs-2020-07-21-ata_2-3-resumo-do-55-reuniao-ordinaria-do-cbh-bs-de-2020-1.docx",
      "data/minutes_files/bs/bs-2005-05-18-ata_2-ata-da-1-re-extra05-18-05-05.doc",
      "data/minutes_files/bs/bs-2008-08-12-ata_2-ata-da-3-reuniao-extraordinaria-do-cbh-bs-2008.doc",
      
      "data/minutes_files/bs/bs-2019-06-18-ata_2-ata-comunicado.docx",
      "data/minutes_files/ln/ln-2008-06-16-ata_2-ata-plenaria-16-06-08.doc",
      "data/minutes_files/mogi/mogi-1996-06-04-ata_12-doc1-0.pdf",
      "data/minutes_files/mogi/mogi-1996-08-15-ata_6-doc2-0.pdf",
      "data/minutes_files/mogi/mogi-1996-08-28-ata_2-doc1.pdf",
      
      
      "data/minutes_files/pcj/pcj-2001-03-30-ata_2-15-ord-cbh-pcj_30-03-01.pdf",
      
      "data/minutes_files/smt/smt-2004-05-28-ata_4-anexo-2.doc",
      "data/minutes_files/smt/smt-2004-05-28-ata_5-anexo-3.doc",
      "data/minutes_files/smt/smt-2006-11-10-ata_2-minuta-36a-1.doc",
      "data/minutes_files/smt/smt-2008-10-07-ata_2-minuta-da-ata-da-43-reuniao-extraordinaria-do-cbh.doc",
      "data/minutes_files/smt/smt-2009-11-06-ata_2-lista-reuniao-mairinque.pdf",
      "data/minutes_files/rb/rb-1996-05-18-ata_2-cbhata00296.pdf",
      "data/minutes_files/rb/rb-1997-06-07-ata_2-cbhata00797.pdf",
      "data/minutes_files/rb/rb-1997-09-13-ata_2-cbhata00997.pdf",
      "data/minutes_files/rb/rb-2000-05-19-ata_2-cbhata02600.pdf",
      "data/minutes_files/rb/rb-2004-05-08-ata_2-cbhata04204.pdf",
      "data/minutes_files/rb/rb-2004-08-14-ata_2-cbhata04304.pdf",
      "data/minutes_files/rb/rb-2004-11-05-ata_2-cbhata04404.pdf",
      "data/minutes_files/rb/rb-2004-12-18-ata_2-cbhextra1404.pdf",
      "data/minutes_files/rb/rb-2005-03-04-ata_2-cbhata04505.pdf",
      "data/minutes_files/rb/rb-2005-06-25-ata_2-cbhata04605.pdf",
      "data/minutes_files/rb/rb-2005-08-27-ata_2-cbhata04705.pdf",
      "data/minutes_files/rb/rb-2005-12-09-ata_2-cbhata04805.pdf",
      "data/minutes_files/rb/rb-2008-09-12-ata_2-cbhextra1708.pdf",
      "data/minutes_files/rb/rb-2008-11-29-ata_2-cbhata05708.pdf",
      "data/minutes_files/rb/rb-2008-12-17-ata_2-cbhextra1808.pdf",
      
      "data/minutes_files/mogi/mogi-1996-08-15-ata_7-doc2.pdf"
      
      
      
    )
  )

# OK: AT, BS, LN, PCJ, SMT, RB
# FALTA: MOGI 9, 


```


ideias:
- ideias para analise: antes, durante, depois da crise hidrica.



Atas que não serão usadas:
at-1994-11-18-ata_1-ata-de-fundacao-e-instalacao-do-cbh-at-doe-18-11-94-caderno-executivo-i-pagina-56.pdf - PDF esquisito

at-2005-07-06-ata_1-ata-reuniao-extraordinaria-do-cbh-at-06_07_05 - Word corrompido

jpgs smt: anexos de outras instituicoes

jpgs mogi: ata escrita a mão, porém há o PDF também. 

tem atas duplicadas, removendo na mão

